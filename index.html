<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>بوت التوليد الشامل</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2481cc;
            --bg-color: #ffffff;
            --text-color: #000000;
            --card-bg: #f4f6f8;
            --border-radius: 12px;
        }
        body.theme-dark {
            --bg-color: #1c1c1e;
            --text-color: #ffffff;
            --card-bg: #2c2c2e;
            --primary-color: #3390ec;
        }
        body { 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            margin: 0; 
            padding: 20px; 
            padding-bottom: 100px; 
            transition: background 0.3s;
        }
        
        /* الهيدر */
        header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        .points-badge {
            background: var(--primary-color); color: white; padding: 5px 12px;
            border-radius: 20px; font-size: 14px; font-weight: bold;
        }

        /* البطاقات */
        .card { 
            background-color: var(--card-bg); 
            padding: 20px; 
            border-radius: var(--border-radius); 
            margin-bottom: 15px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        /* الأزرار */
        .btn { 
            width: 100%; 
            padding: 14px; 
            background: var(--primary-color); 
            color: white; 
            border: none; 
            border-radius: 10px; 
            font-size: 16px; 
            font-weight: bold; 
            cursor: pointer; 
            margin-top: 10px; 
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-outline { background: transparent; border: 2px solid var(--primary-color); color: var(--text-color); margin-top: 5px; }
        
        /* الشبكة */
        .menu-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 12px; 
        }
        .menu-item { 
            background: var(--card-bg); 
            padding: 25px 10px; 
            border-radius: var(--border-radius); 
            text-align: center; 
            cursor: pointer; 
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .menu-item:active { background: rgba(0,0,0,0.05); }
        .menu-item i { font-size: 28px; margin-bottom: 10px; color: var(--primary-color); }
        
        /* المدخلات */
        input, select { 
            width: 100%; 
            padding: 14px; 
            margin-bottom: 15px; 
            border-radius: 10px; 
            border: 1px solid #ddd; 
            box-sizing: border-box; 
            background: var(--bg-color);
            color: var(--text-color);
            font-size: 16px;
        }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color); opacity: 0.8; font-size: 14px; }

        /* صفحة النتائج المحسنة */
        .results-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-top: 15px;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .results-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed rgba(0,0,0,0.1);
        }
        .results-count { font-weight: bold; color: var(--primary-color); }
        
        .results-preview {
            max-height: 200px;
            overflow-y: auto;
            background: var(--bg-color);
            border-radius: 8px;
            padding: 10px;
            font-family: monospace;
            font-size: 13px;
            color: #666;
            margin-bottom: 15px;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .preview-line { padding: 4px 0; border-bottom: 1px solid #eee; }
        
        .download-options { display: flex; gap: 10px; margin-top: 10px; }
        .dl-btn {
            flex: 1; padding: 10px; border-radius: 8px; border: none; cursor: pointer;
            font-size: 13px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .dl-txt { background: #e3f2fd; color: #1565c0; }
        .dl-csv { background: #e8f5e9; color: #2e7d32; }

        /* العناصر */
        .hidden { display: none !important; }
        .loader { text-align: center; padding: 20px; color: var(--primary-color); }
        
        .toast { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
            background: rgba(0,0,0,0.9); color: white; padding: 12px 24px; 
            border-radius: 30px; font-size: 14px; opacity: 0; pointer-events: none; z-index: 1000; transition: opacity 0.3s;
        }
        
        .nav-back { display: flex; align-items: center; gap: 10px; cursor: pointer; color: var(--primary-color); font-weight: bold; margin-bottom: 15px; }
    </style>
</head>
<body>

    <!-- الهيدر -->
    <header>
        <div style="font-weight: bold; font-size: 18px;">نجم الإحالات 3</div>
        <div class="points-badge" id="header-points">...</div>
    </header>

    <!-- الرئيسية -->
    <div id="screen-home" class="screen">
        <div class="card" style="text-align: center; background: linear-gradient(135deg, #2481cc, #1a5c96); color: white;">
            <div style="font-size: 14px; opacity: 0.9;">الرصيد الحالي</div>
            <div style="font-size: 32px; font-weight: bold; margin: 5px 0;" id="main-balance">0</div>
        </div>

        <div class="menu-grid">
            <div class="menu-item" onclick="nav.to('phones')">
                <i class="fas fa-mobile-alt"></i>
                <div>توليد أرقام</div>
            </div>
            <div class="menu-item" onclick="nav.to('emails')">
                <i class="fas fa-envelope"></i>
                <div>توليد إيميلات</div>
            </div>
            <div class="menu-item" onclick="nav.to('usernames')">
                <i class="fas fa-user-tag"></i>
                <div>توليد يوزرات</div>
            </div>
            <div class="menu-item" onclick="nav.to('points')">
                <i class="fas fa-coins"></i>
                <div>نقاطي</div>
            </div>
        </div>
    </div>

    <!-- صفحة الأرقام -->
    <div id="screen-phones" class="screen hidden">
        <div class="nav-back" onclick="nav.home()"><i class="fas fa-arrow-right"></i> رجوع</div>
        <div class="card">
            <label>نوع التوليد</label>
            <select id="phone-mode" onchange="togglePhone()">
                <option value="specific">دولة محددة</option>
                <option value="random">عشوائي</option>
            </select>
            <div id="phone-country-group">
                <label>الدولة</label>
                <select id="phone-country">
                    <option value="966">السعودية (+966)</option>
                    <option value="971">الإمارات (+971)</option>
                    <option value="20">مصر (+20)</option>
                    <option value="962">الأردن (+962)</option>
                    <option value="965">الكويت (+965)</option>
                    <option value="974">قطر (+974)</option>
                    <option value="973">البحرين (+973)</option>
                    <option value="968">عمان (+968)</option>
                    <option value="967">اليمن (+967)</option>
                </select>
            </div>
            <label>العدد (1-10000)</label>
            <input type="number" id="phone-count" value="10" oninput="updateCost('phone')">
            <button class="btn" onclick="gen.phones()">توليد الآن</button>
            <div style="margin-top:10px; text-align:center; font-size:12px; color:var(--primary-color);">
                التكلفة: <span id="phone-cost">10</span> نقطة
            </div>
        </div>
        
        <!-- منطقة النتائج المحسنة -->
        <div id="phones-result-area" class="results-card hidden">
            <div class="results-header">
                <span class="results-count">تم التوليد: <span id="phones-total">0</span></span>
                <i class="fas fa-check-circle" style="color: var(--success-color, #2ecc71)"></i>
            </div>
            <div class="loader hidden" id="phones-loader"><i class="fas fa-spinner fa-spin"></i> جاري المعالجة...</div>
            <div class="results-preview" id="phones-list"></div>
            <div class="download-options">
                <button class="dl-btn dl-txt" onclick="downloadData('phones', 'txt')"><i class="fas fa-file-alt"></i> TXT</button>
                <button class="dl-btn dl-csv" onclick="downloadData('phones', 'csv')"><i class="fas fa-file-csv"></i> Excel/CSV</button>
            </div>
        </div>
    </div>

    <!-- صفحة الإيميلات -->
    <div id="screen-emails" class="screen hidden">
        <div class="nav-back" onclick="nav.home()"><i class="fas fa-arrow-right"></i> رجوع</div>
        <div class="card">
            <label>النطاق (مثال: gmail.com)</label>
            <input type="text" id="email-domain" value="gmail.com">
            <label>العدد (1-10000)</label>
            <input type="number" id="email-count" value="10" oninput="updateCost('email')">
            <button class="btn" onclick="gen.emails()">توليد الآن</button>
            <div style="margin-top:10px; text-align:center; font-size:12px; color:var(--primary-color);">
                التكلفة: <span id="email-cost">10</span> نقطة
            </div>
        </div>
        
        <div id="emails-result-area" class="results-card hidden">
            <div class="results-header">
                <span class="results-count">تم التوليد: <span id="emails-total">0</span></span>
                <i class="fas fa-check-circle" style="color: #2ecc71"></i>
            </div>
            <div class="loader hidden" id="emails-loader"><i class="fas fa-spinner fa-spin"></i> جاري المعالجة...</div>
            <div class="results-preview" id="emails-list"></div>
            <div class="download-options">
                <button class="dl-btn dl-txt" onclick="downloadData('emails', 'txt')"><i class="fas fa-file-alt"></i> TXT</button>
                <button class="dl-btn dl-csv" onclick="downloadData('emails', 'csv')"><i class="fas fa-file-csv"></i> Excel/CSV</button>
            </div>
        </div>
    </div>

    <!-- صفحة اليوزرات -->
    <div id="screen-usernames" class="screen hidden">
        <div class="nav-back" onclick="nav.home()"><i class="fas fa-arrow-right"></i> رجوع</div>
        <div class="card">
            <label>العدد (1-1000)</label>
            <input type="number" id="user-count" value="10" oninput="updateCost('user')">
            <label>النمط (استخدم $ للمتغير)</label>
            <input type="text" id="user-pattern" value="user$">
            <small style="color:var(--text-color); opacity:0.6; display:block; margin-bottom:10px;">مثال: user$ سينتج userA, userB...</small>
            <button class="btn" onclick="gen.usernames()">توليد الآن</button>
            <div style="margin-top:10px; text-align:center; font-size:12px; color:var(--primary-color);">
                التكلفة: <span id="user-cost">10</span> نقطة
            </div>
        </div>

        <div id="users-result-area" class="results-card hidden">
            <div class="results-header">
                <span class="results-count">تم التوليد: <span id="users-total">0</span></span>
                <i class="fas fa-check-circle" style="color: #2ecc71"></i>
            </div>
            <div class="loader hidden" id="users-loader"><i class="fas fa-spinner fa-spin"></i> جاري المعالجة...</div>
            <div class="results-preview" id="users-list"></div>
            <div class="download-options">
                <button class="dl-btn dl-txt" onclick="downloadData('users', 'txt')"><i class="fas fa-file-alt"></i> TXT</button>
                <button class="dl-btn dl-csv" onclick="downloadData('users', 'csv')"><i class="fas fa-file-csv"></i> Excel/CSV</button>
            </div>
        </div>
    </div>

    <!-- صفحة النقاط -->
    <div id="screen-points" class="screen hidden">
        <div class="nav-back" onclick="nav.home()"><i class="fas fa-arrow-right"></i> رجوع</div>
        <div class="card">
            <h3>الهدية اليومية</h3>
            <p style="opacity:0.7">احصل على 100 نقطة كل 24 ساعة.</p>
            <button class="btn" id="btn-daily" onclick="points.claim()">استلام الهدية</button>
        </div>
    </div>

    <div id="toast" class="toast">رسالة</div>

    <script>
        // === الإعدادات ===
        // استبدل هذا الرابط برابط السيرفر الخاص بك (مثل Render)
        const API_URL = "https://alltgservices-2.onrender.com"; 

        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // استخراج معرف المستخدم
        const urlParams = new URLSearchParams(window.location.search);
        const USER_ID = urlParams.get('user_id') || (tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 'guest');

        // دعم الثيم
        if (tg.themeParams.bg_color) {
            document.body.style.backgroundColor = tg.themeParams.bg_color;
            document.body.style.color = tg.themeParams.text_color;
            if(tg.themeParams.bg_color === '#1c1c1e') document.body.classList.add('theme-dark');
        }

        const $ = (id) => document.getElementById(id);
        const showToast = (msg) => {
            const t = $('toast'); t.innerText = msg; t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 3000);
        };

        // === إدارة الحالة ===
        let currentResults = {}; // تخزين النتائج مؤقتاً للتحميل

        // === تحديث الرصيد ===
        async function updateBalance() {
            try {
                const res = await fetch(`${API_URL}/api/user`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: USER_ID})
                });
                const data = await res.json();
                $('main-balance').innerText = data.points;
                $('header-points').innerText = data.points + " نقطة";
                
                // تحديث زر الهدية
                if(data.can_claim_daily) {
                    $('btn-daily').disabled = false;
                    $('btn-daily').innerText = "استلام الهدية";
                    $('btn-daily').style.opacity = "1";
                } else {
                    $('btn-daily').disabled = true;
                    $('btn-daily').innerText = "تم الاستلام اليوم ✅";
                    $('btn-daily').style.opacity = "0.5";
                }
            } catch (e) {
                $('main-balance').innerText = "offline";
            }
        }

        const nav = {
            to: (screen) => {
                document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
                $(`screen-${screen}`).classList.remove('hidden');
            },
            home: () => {
                document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
                $('screen-home').classList.remove('hidden');
                updateBalance();
            }
        };

        function togglePhone() {
            const mode = $('phone-mode').value;
            $('phone-country-group').style.display = mode === 'specific' ? 'block' : 'none';
        }

        function updateCost(type) {
            const inputs = { 'phone': $('phone-count'), 'email': $('email-count'), 'user': $('user-count') };
            const displays = { 'phone': $('phone-cost'), 'email': $('email-cost'), 'user': $('user-cost') };
            const val = parseInt(inputs[type].value) || 0;
            displays[type].innerText = val;
        }

        // === منطق التوليد ===
        const gen = {
            process: async (type, endpoint, bodyData) => {
                const count = parseInt(bodyData.count) || 0;
                const cost = count; // تكلفة 1 لكل عنصر

                // إظهار اللودر وإخفاء النتائج القديمة
                const resultArea = $(`${type}-result-area`);
                const loader = $(`${type}-loader`);
                const list = $(`${type}-list`);
                
                resultArea.classList.remove('hidden');
                loader.classList.remove('hidden');
                list.innerHTML = '';
                $(`${type}-total`).innerText = '0';

                try {
                    const res = await fetch(`${API_URL}${endpoint}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({user_id: USER_ID, ...bodyData})
                    });
                    const data = await res.json();
                    
                    loader.classList.add('hidden');

                    if (data.error) {
                        showToast(data.error);
                        resultArea.classList.add('hidden');
                        return;
                    }

                    // النجاح
                    const results = data.data;
                    currentResults[type] = results; // حفظ للتحميل
                    $(`${type}-total`).innerText = results.length;
                    updateBalance(); // تحديث الرصيد
                    showToast("تم التوليد بنجاح!");

                    // عرض أول 10 عناصر فقط في المعاينة
                    const previewHTML = results.slice(0, 10).map(item => `<div class="preview-line">${item}</div>`).join('');
                    if (results.length > 10) {
                         list.innerHTML = previewHTML + `<div class="preview-line" style="text-align:center; color:#999;">... و ${results.length - 10} آخرين (قم بالتحميل)</div>`;
                    } else {
                        list.innerHTML = previewHTML;
                    }

                } catch (e) {
                    loader.classList.add('hidden');
                    showToast("خطأ في الاتصال");
                }
            },

            phones: () => {
                const count = $('phone-count').value;
                const mode = $('phone-mode').value;
                const code = $('phone-country').value;
                gen.process('phones', '/api/generate/phones', { count, mode, code });
            },

            emails: () => {
                const count = $('email-count').value;
                const domain = $('email-domain').value;
                gen.process('emails', '/api/generate/emails', { count, domain });
            },

            usernames: () => {
                const count = $('user-count').value;
                const pattern = $('user-pattern').value;
                gen.process('users', '/api/generate/usernames', { count, pattern });
            }
        };

        const points = {
            claim: async () => {
                try {
                    const res = await fetch(`${API_URL}/api/claim_daily`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({user_id: USER_ID})
                    });
                    const data = await res.json();
                    if (data.status === 'success') {
                        showToast("تمت الإضافة!");
                        updateBalance();
                    } else {
                        showToast(data.error);
                    }
                } catch (e) { 
                    showToast("خطأ في الاتصال"); 
                }
            }
        };

        // === التحميل ===
        function downloadData(type, format) {
            if (!currentResults[type]) return;
            
            let content, filename, mime;

            if (format === 'csv') {
                // تنسيق CSV يدعم العربية والإنجليزية
                const csvRows = ["Data"]; // Header
                currentResults[type].forEach(row => {
                    csvRows.push(`"${row}"`);
                });
                content = csvRows.join("\n");
                filename = `${type}_results.csv`;
                mime = 'text/csv';
            } else {
                // تنسيق TXT عادي
                content = currentResults[type].join("\n");
                filename = `${type}_results.txt`;
                mime = 'text/plain';
            }

            const blob = new Blob(["\ufeff" + content], { type: mime }); // \ufeff لتصحيح الترميز في Excel
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }

        // تشغيل الوظائف عند فتح التطبيق
        window.onload = () => {
            updateBalance();
            togglePhone(); // تهيئة حالة صفحة الأرقام
        };

    </script>
</body>
</html>